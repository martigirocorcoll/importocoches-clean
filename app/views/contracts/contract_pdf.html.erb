<% require 'base64' %>
<% require 'open-uri' %>

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      font-size: 14px;
      line-height: 1.4;
      margin: 0;
      padding: 0;
    }
    .header {
      margin-bottom: 5px;
    }
    .company-info {
      text-align: right;
      font-size: 12px;
    }
    h1 {
      font-size: 18px;
      margin: 10px 0;
    }
    .section {
      margin: 10px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #000;
    }
    .data-row {
      margin: 6px 0;
    }
    .data-row strong {
      display: inline-block;
      width: 200px;
    }
    .precio-row {
      margin: 8px 0;
      padding-left: 30px;
    }
    .clausulas {
      margin-top: 15px;
      text-align: justify;
    }
    .clausulas p {
      margin: 6px 0;
    }
    .signature-section {
      margin-top: 40px;
      display: table;
      width: 100%;
    }
    .signature-box {
      display: table-cell;
      width: 45%;
      text-align: center;
      vertical-align: bottom;
    }
    .signature-line {
      border-bottom: 1px solid #000;
      margin: 0 20px 5px 20px;
      height: 70px;
    }
    .page-break {
      page-break-after: always;
    }

    /* Estilos para el anexo */
    .car-specs-table {
      width: 100%;
      border-collapse: collapse;
      margin: auto;
    }
    .car-specs-table td {
      border: 1px solid #BFBFBF;
      padding: 15px 10px;
      text-align: center;
    }
    .car-specs-table .header-cell {
      background-color: #f8f9fa;
      font-weight: bold;
    }
    .car-specs-table .data-cell {
      background-color: #FAECF0;
    }
    .car-image {
      max-width: 100%;
      height: auto;
    }
    .image-gallery table {
      width: 100%;
      border-collapse: collapse;
    }
    .image-gallery td {
      width: 50%;
      padding: 5px;
    }
  </style>
</head>
<body>
  <!-- PÁGINA 1: CONTRATO -->
  <!-- Header -->
  <div class="header">
    <table style="width:100%; cellpadding: 0; cellspacing: 0;">
      <tr>
        <td style="padding: 0;">
          <%= wicked_pdf_image_tag "logo.png", alt: "Importo Cotxe logo", style: "height: 120px;" %>
        </td>
        <td style="padding: 0;">
          <p style="text-align:right; font-family: Arial, Helvetica, sans-serif; font-size: 10px; margin: 0; padding: 0;"><strong>Importocotxe</strong></p>
          <p style="text-align:right; font-family: Arial, Helvetica, sans-serif; font-size: 10px; margin: 0; padding: 0;"><strong>Brava A&M Solutions SL L-717603-E</strong></p>
          <p style="text-align:right; font-family: Arial, Helvetica, sans-serif; font-size: 10px; margin: 0; padding: 0;">C/ del Clos 01, Bloca A, casa 2A</p>
          <p style="text-align:right; font-family: Arial, Helvetica, sans-serif; font-size: 10px; margin: 0; padding: 0;">AD300 Ordino</p>
        </td>
      </tr>
    </table>
  </div>

  <!-- Título del documento -->
  <h1 style="text-align: center; font-size: 20px; margin: 15px 0 10px 0; font-weight: bold;">CONTRATO DE RESERVA DE VEHÍCULO</h1>

  <!-- Fecha -->
  <div style="text-align: center; margin-bottom: 15px;">
    <strong>Fecha: <%= @contract_data[:fecha] %></strong>
  </div>

  <!-- IDENTIFICACIÓN DEL CLIENTE -->
  <div class="section">
    <h1>IDENTIFICACIÓN DEL CLIENTE</h1>

    <% if @contract_data[:empresa].present? %>
      <strong><p>Empresa: </strong> <%= @contract_data[:empresa] %></p>
      <strong><p>NRT: </strong> <%= @contract_data[:nrt] %></p>
      <strong><p>Representada por: </strong> <%= @contract_data[:nombre] %></p>
      <strong><p>NIA: </strong> <%= @contract_data[:nia] %></p>
    <% else %>
      <strong><p>Nombre: </strong><%= @contract_data[:nombre] %></p>
      <strong><p>NIA: </strong><%= @contract_data[:nia] %></p>
    <% end %>
    <strong><p>Domicilio:</strong> <%= @contract_data[:domicilio] %></p>
  </div>

  <!-- DATOS DEL VEHÍCULO -->
  <div class="section">
    <h1>DATOS DEL VEHÍCULO</h1>

    <table style="width: 100%; border-collapse: collapse; background-color: white;">
      <tr>
        <td style="width: 25%; text-align: center; padding: 10px; border: none; border-bottom: 1px solid #000;">
          <strong>Modelo</strong>
        </td>
        <td style="width: 25%; text-align: center; padding: 10px; border: none; border-bottom: 1px solid #000;">
          <strong>Kilometraje</strong>
        </td>
        <td style="width: 25%; text-align: center; padding: 10px; border: none; border-bottom: 1px solid #000;">
          <strong>Primera matriculación</strong>
        </td>
        <td style="width: 25%; text-align: center; padding: 10px; border: none; border-bottom: 1px solid #000;">
          <strong>Número de chasis</strong>
        </td>
      </tr>
      <tr>
        <td style="text-align: center; padding: 10px; border: none;">
          <%= @contract_data[:marca_model] %>
        </td>
        <td style="text-align: center; padding: 10px; border: none;">
          <%= @contract_data[:km] %> km *
        </td>
        <td style="text-align: center; padding: 10px; border: none;">
          <%= @contract_data[:primera_matriculacion] %>
        </td>
        <td style="text-align: center; padding: 10px; border: none;">
          <%= @contract_data[:chassis] %>
        </td>
      </tr>
    </table>

    <p style="font-size: 10px; margin-top: 15px;"><strong>*</strong> El kilometraje indicado corresponde al registrado en el momento de su adquisición y podrá incrementarse ligeramente por gestiones de transporte, importación y matriculación. Este aumento será mínimo y no dará lugar a reclamación, cancelación o ajuste de precio.</p>
  </div>

  <!-- PRECIO Y FORMA DE PAGO -->
  <div class="section">
    <h1>PRECIO Y FORMA DE PAGO</h1>
    <p><strong>Precio total:</strong> <%= number_with_precision(@contract_data[:venta_total].to_f, precision: 0, delimiter: ".") %> €</p>
    <p style="margin-left: 15px; font-size: 12px; font-style: italic;">(Incluye matriculación en Andorra, IGI 4,5% y un año de garantía)</p>

    <p><strong>Forma de pago:</strong></p>
    <p style="margin-left: 15px;"><strong>Primer pago (reserva):</strong> <%= number_with_precision(@contract_data[:deposito].to_f, precision: 0, delimiter: ".") %> € para efectuar la reserva en origen.</p>
    <p style="margin-left: 15px;"><strong>Segundo pago:</strong> <%= number_with_precision(@contract_data[:pago_restante].to_f, precision: 0, delimiter: ".") %> €, a realizar en un plazo máximo de 5 días naturales desde que Importocotxe confirme al Cliente que el vehículo está listo para su compra en origen.</p>

    <p style="margin-top: 20px;"><strong>Datos bancarios para la transferencia:</strong></p>
    <p style="margin-left: 15px;"><strong>IBAN:</strong> AD06 0001 0000 4170 7580 0100</p>
    <p style="margin-left: 15px;"><strong>BIC:</strong> BACA AD AD</p>
  </div>

  <!-- CLÁUSULAS -->
  <div class="section">
    <h1>CLÁUSULAS</h1>

    <p><strong>1. Indisponibilidad del vehículo en origen:</strong></p>
    <p>En caso de que, tras la reserva en origen, el vehículo quede no disponible por causas ajenas a Importocotxe, este:</p>
    <p style="margin-left: 15px;">a) Ofrecerá al Cliente un vehículo de características y precio similares, o</p>
    <p style="margin-left: 15px;">b) Reembolsará íntegramente el importe abonado en concepto de reserva en un plazo máximo de 1 día hábil, si el Cliente no acepta la alternativa.</p>

    <p><strong>2. Cancelaciones:</strong></p>
    <p><strong style="margin-left: 15px;">2.1. Cancelación en fase de reserva</strong></p>
    <p style="margin-left: 15px;">Una vez hecha la reserva, Importocotxe bloquea el vehículo en origen y adelanta el importe al proveedor.</p>
    <p style="margin-left: 15px;">Si el Cliente decide no seguir adelante y el pago ya se ha transferido, esa cantidad no se podrá devolver, ya que no es recuperable del proveedor.</p>

    <p><strong style="margin-left: 15px;">2.2. Cancelación en la entrega</strong></p>
    <p style="margin-left: 15px;">Si en la entrega el vehículo presenta diferencias relevantes respecto a lo acordado en cuanto a modelo, versión, equipamiento esencial o estado general, y no es posible corregirlas, el Cliente podrá cancelar la compra y recuperar lo abonado.</p>
    <p style="margin-left: 15px;">Si dichas diferencias o defectos pueden corregirse, Importocotxe se hará cargo de gestionarlo de forma inmediata y cubrirá todos los costes necesarios para dejar el vehículo conforme a lo acordado, incluso si dichos costes provocan pérdidas en la importación del vehículo para Importocotxe.</p>

    <p><strong>3. Plazo de entrega:</strong></p>
    <p>Importocotxe se compromete a gestionar y efectuar el pago en origen de forma diligente para que el vehículo llegue en el plazo previsto. El plazo estimado de entrega es de unas tres semanas desde la recepción del segundo pago.</p>
    <p>Este plazo es orientativo y puede variar por causas ajenas a Importocotxe, como transporte, aduanas, matriculación o trámites administrativos.</p>

    <p><strong>4. Estado y equipamiento:</strong></p>
    <p>El vehículo se entregará en buen estado de funcionamiento y conservación, acorde a su antigüedad y kilometraje, con el equipamiento descrito en el Anexo 1.</p>
    <p>El Anexo 1 forma parte inseparable de este contrato y el Cliente declara haberlo recibido y revisado en el momento de formalizar la reserva.</p>

    <p><strong>5. Jurisdicción y ley aplicable:</strong></p>
    <p>Este contrato se rige por las leyes del Principado de Andorra. Cualquier controversia será resuelta exclusivamente por los tribunales de Andorra.</p>

    <p><strong>6. Aceptación:</strong></p>
    <p>El presente contrato se considerará plenamente aceptado y vinculante desde el momento en que el Cliente efectúe el pago total o parcial de la reserva, incluso si no lo ha firmado físicamente.</p>
  </div>

  <!-- COMENTARIOS ADICIONALES (only if present) -->
  <% if @contract_data[:comentarios].present? %>
  <div class="section">
    <h1>COMENTARIOS ADICIONALES</h1>
    <p style="text-align: justify; margin: 10px 0;">
      <%= simple_format(@contract_data[:comentarios]) %>
    </p>
  </div>
  <% end %>

  <!-- Signatures -->
  <div class="signature-section">
    <div class="signature-box">
      <div class="signature-line"></div>
      <strong>Firma Importocotxe</strong>
    </div>
    <div style="display: table-cell; width: 10%;"></div>
    <div class="signature-box">
      <div class="signature-line"></div>
      <strong>Firma Cliente</strong>
    </div>
  </div>


  <!-- Page break for Anexo -->
  <div class="page-break"></div>

  <!-- ANEXO: FICHA DEL VEHÍCULO -->
  <% if @car.present? %>
    <!-- Header del anexo -->
    <div style="padding-bottom: 30px; margin-bottom: 30px;">
      <table style="width:100%">
        <tr>
          <td>
            <%= wicked_pdf_image_tag "logo.png", alt: "Importo Cotxe logo" %>
          </td>
          <td>
            <p style="text-align:right; font-family: Arial, Helvetica, sans-serif;">+376 666 488</p>
            <p style="text-align:right; font-family: Arial, Helvetica, sans-serif;">info@importocotxe.ad</p>
            <p style="text-align:right; font-family: Arial, Helvetica, sans-serif;">https://www.importocotxe.ad</p>
          </td>
        </tr>
      </table>
    </div>

    <!-- Título del anexo -->
    <div>
      <h1 style="text-align:center; font-family: Arial, Helvetica, sans-serif;">
        Anexo 1: <%= @contract_data[:marca_model] %>
      </h1>
    </div>
    <br><br>

    <!-- Imagen principal del coche (Base64 Embedded) -->
    <div style="text-align:center;">
      <% if @car.images.first.present? %>
        <% begin %>
          <% blob = @car.images.first.is_a?(String) ? URI.open(@car.images.first).read : @car.images.first.blob.download %>
          <% data = Base64.strict_encode64(blob) %>
          <% mime = @car.images.first.is_a?(String) ? MIME::Types.type_for(@car.images.first).first.content_type : @car.images.first.blob.content_type %>
          <%= image_tag "data:#{mime};base64,#{data}", class: "car-image", alt: "#{@car.make} #{@car.model_description}" %>
        <% rescue => e %>
          <p>Imagen no disponible</p>
        <% end %>
      <% end %>
    </div>

    <div class="page-break"></div>

    <!-- Especificaciones técnicas -->
    <div style="font-size:12px;">
      <div style="padding-bottom: 15px; margin-bottom: 20px;">
        <table style="width:100%">
          <tr>
            <td>
              <%= wicked_pdf_image_tag "logo.png", alt: "Importo Cotxe logo" %>
            </td>
            <td>
              <p style="text-align:right; font-family: Arial, Helvetica, sans-serif;">+376 666 488</p>
              <p style="text-align:right; font-family: Arial, Helvetica, sans-serif;">info@importocotxe.ad</p>
              <p style="text-align:right; font-family: Arial, Helvetica, sans-serif;">https://www.importocotxe.ad</p>
            </td>
          </tr>
        </table>
      </div>

      <!-- Tabla de especificaciones -->
      <div>
        <table class="car-specs-table">
          <tr>
            <td class="header-cell" style="width: 230px;"><h4>Kilometraje</h4></td>
            <td class="header-cell" style="width: 230px;"><h4>1ª Matriculación</h4></td>
            <td class="header-cell" style="width: 230px;"><h4>Potencia</h4></td>
            <td class="header-cell" style="width: 230px;"><h4>Combustible</h4></td>
          </tr>
          <tr>
            <td class="data-cell"><h5><%= "#{number_with_precision(@car.mileage, precision: 0, delimiter: '.')} km" %></h5></td>
            <td class="data-cell"><h5><%= DateTime.parse("#{@car.first_registration_date}-01").strftime("%m-%Y") %></h5></td>
            <td class="data-cell"><h5><%= "#{(@car.power.to_i * 1.3595).round} cv" %></h5></td>
            <td class="data-cell"><h5><%= @car.fuel %></h5></td>
          </tr>
        </table>
      </div>

      <!-- Descripción del equipamiento -->
      <div>
        <h2 style="text-align:left; font-family: Arial, Helvetica, sans-serif; padding-top: 35px;">Equipamiento:</h2>
        <h3 style="text-align:left; font-family: Arial, Helvetica, sans-serif; padding-top: 15px;">
          <% if @description.present? %>
            <%= simple_format(@description) %>
          <% else %>
            <%= sanitize(@car.equipment_list.join(', ')) if @car.respond_to?(:equipment_list) %>
          <% end %>
        </h3>
        <h2 style="text-align:left; font-family: Arial, Helvetica, sans-serif; padding-top: 45px;">
          Precio final ................................................................ <%= @final_price %> €
        </h2>
      </div>
    </div>

    <div class="page-break"></div>

    <!-- Galería de imágenes: 2 Columnas x 3 Filas por página -->
    <% if @car.images.size > 1 %>
      <% @car.images[1..-1].each_slice(6).with_index do |page_images, page_index| %>
        <div style="page-break-after: <%= 'always' if page_index < (@car.images.size/6.0).ceil - 1 %>; margin-bottom: 20px;">
          <table style="width:100%; border-collapse: collapse;">
            <% page_images.each_slice(2) do |row_images| %>
              <tr>
                <% row_images.each do |img| %>
                  <% begin %>
                    <% raw_data = img.is_a?(String) ? URI.open(img).read : img.blob.download %>
                    <% encoded  = Base64.strict_encode64(raw_data) %>
                    <% mime     = img.is_a?(String) ? MIME::Types.type_for(img).first.content_type : img.blob.content_type %>
                    <td style="width:50%; padding: 5px;">
                      <%= image_tag "data:#{mime};base64,#{encoded}", style: "width:100%; height:auto;" %>
                    </td>
                  <% rescue => e %>
                    <td style="width:50%; padding: 5px;">
                      <p>Imagen no disponible</p>
                    </td>
                  <% end %>
                <% end %>
                <% if row_images.size < 2 %>
                  <td style="width:50%; padding: 5px;"></td>
                <% end %>
              </tr>
            <% end %>
          </table>
        </div>
      <% end %>
    <% end %>
  <% else %>
    <!-- Si no hay datos del coche de la API, mostrar solo la descripción -->
    <div style="padding-bottom: 30px; margin-bottom: 30px;">
      <table style="width:100%">
        <tr>
          <td>
            <%= wicked_pdf_image_tag "logo.png", alt: "Importo Cotxe logo" %>
          </td>
          <td style="text-align: right;">
            <p>IMPORTOCOTXE.AD</p>
            <p>+376 666 488</p>
            <p>info@importocotxe.ad</p>
            <p>https://www.importocotxe.ad</p>
          </td>
        </tr>
      </table>
    </div>

    <h1 style="text-align: center;">Anexo 1: <%= @contract_data[:marca_model] %></h1>

    <% if @contract_data[:descripcion_traducida].present? %>
      <div style="margin: 30px 0;">
        <h2>Descripción del vehículo:</h2>
        <p style="text-align: justify;">
          <%= simple_format(@contract_data[:descripcion_traducida]) %>
        </p>
      </div>
    <% end %>
  <% end %>
</body>
</html>
