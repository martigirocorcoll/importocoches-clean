<div class="dashboard-header" style="margin-bottom: 30px;">
  <h1 style="color: #2c3e50; font-size: 28px; margin-bottom: 10px;">
    <i class="fa-solid fa-search"></i> Búsqueda de Referencias WhatsApp
  </h1>
  <p style="color: #7f8c8d;">Busca información de atribución por número de referencia</p>
</div>

<div class="attribution-search-container" style="max-width: 100%;">

  <!-- Search Form -->
  <div class="search-form" style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px;">
    <%= form_with url: dashboard_attribution_path, method: :get, local: true, html: { style: "display: flex; gap: 15px; align-items: end;" } do |f| %>
      <div style="flex: 1;">
        <%= f.label :reference, "Número de Referencia:", style: "display: block; margin-bottom: 5px; font-weight: bold; color: #34495e;" %>
        <%= f.text_field :reference, 
            value: @reference, 
            placeholder: "Ej: WA240805001", 
            style: "width: 100%; padding: 12px; border: 2px solid #bdc3c7; border-radius: 5px; font-size: 16px; text-transform: uppercase;" %>
      </div>
      <div>
        <%= f.submit "Buscar", 
            style: "background: #27ae60; color: white; padding: 12px 25px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold;" %>
      </div>
    <% end %>
  </div>

  <!-- Results Section -->
  <% if @reference.present? %>
    <% if @contact %>
      <!-- Contact Found -->
      <div class="results-found" style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <div class="result-header" style="display: flex; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #ecf0f1;">
          <i class="fa-solid fa-check-circle" style="color: #27ae60; font-size: 24px; margin-right: 15px;"></i>
          <div>
            <h2 style="color: #27ae60; margin: 0; font-size: 24px;">¡Referencia Encontrada!</h2>
            <p style="color: #7f8c8d; margin: 5px 0 0 0;">Información del contacto y atribución de campaña</p>
          </div>
        </div>

        <div class="attribution-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
          <!-- Contact Information -->
          <div class="contact-info">
            <h3 style="color: #2c3e50; margin-bottom: 15px; display: flex; align-items: center;">
              <i class="fa-solid fa-user" style="margin-right: 10px;"></i>
              Información del Contacto
            </h3>
            <div class="info-item" style="margin-bottom: 12px;">
              <strong style="color: #34495e;">Nombre:</strong>
              <span style="margin-left: 8px;"><%= @attribution_info[:name] %></span>
            </div>
            <div class="info-item" style="margin-bottom: 12px;">
              <strong style="color: #34495e;">Teléfono:</strong>
              <span style="margin-left: 8px;"><%= @attribution_info[:phone] %></span>
            </div>
            <div class="info-item" style="margin-bottom: 12px;">
              <strong style="color: #34495e;">Email:</strong>
              <span style="margin-left: 8px;"><%= @attribution_info[:email] %></span>
            </div>
            <div class="info-item" style="margin-bottom: 12px;">
              <strong style="color: #34495e;">Fecha de Contacto:</strong>
              <span style="margin-left: 8px;"><%= @attribution_info[:created_at] %></span>
            </div>
            <% if @attribution_info[:user_email].present? %>
              <div class="info-item">
                <strong style="color: #34495e;">Usuario Registrado:</strong>
                <%= link_to admin_user_path(@attribution_info[:user_id]), 
                    target: "_blank",
                    style: "margin-left: 8px; padding: 3px 8px; background: #27ae60; color: white; border-radius: 3px; font-size: 12px; text-decoration: none; display: inline-block;" do %>
                  <%= @attribution_info[:user_email] %> (ID: <%= @attribution_info[:user_id] %>)
                  <i class="fa-solid fa-external-link-alt" style="margin-left: 5px; font-size: 10px;"></i>
                <% end %>
              </div>
            <% end %>
          </div>

          <!-- Attribution Information -->
          <div class="attribution-info">
            <h3 style="color: #2c3e50; margin-bottom: 15px; display: flex; align-items: center;">
              <i class="fa-solid fa-chart-line" style="margin-right: 10px;"></i>
              Información de Campaña
            </h3>
            <div class="info-item" style="margin-bottom: 12px;">
              <strong style="color: #34495e;">Parámetros UTM:</strong>
              <div style="margin-top: 5px; padding: 8px; background: #f8f9fa; border-radius: 4px; word-break: break-all; font-size: 12px; font-family: monospace;">
                <%= @attribution_info[:utm_params] %>
              </div>
            </div>
            <div class="info-item" style="margin-bottom: 12px;">
              <strong style="color: #34495e;">Origen:</strong>
              <span style="margin-left: 8px;"><%= @attribution_info[:source] %></span>
            </div>
          </div>
        </div>
        
        <!-- Page Information -->
        <div class="page-info" style="grid-column: 1 / -1; margin-top: 20px; padding-top: 20px; border-top: 1px solid #ecf0f1;">
          <h3 style="color: #2c3e50; margin-bottom: 15px; display: flex; align-items: center;">
            <i class="fa-solid fa-globe" style="margin-right: 10px;"></i>
            Página de Origen
          </h3>
          <div class="info-item">
            <strong style="color: #34495e;">URL donde hizo click:</strong>
            <div style="margin-top: 5px; padding: 8px; background: #f8f9fa; border-radius: 4px; word-break: break-all; font-size: 12px; font-family: monospace;">
              <%= @attribution_info[:page_url] %>
            </div>
          </div>
        </div>
      </div>

    <% else %>
      <!-- Contact Not Found -->
      <div class="results-not-found" style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
        <i class="fa-solid fa-exclamation-triangle" style="color: #e74c3c; font-size: 48px; margin-bottom: 20px;"></i>
        <h2 style="color: #e74c3c; margin-bottom: 15px;">Referencia No Encontrada</h2>
        <p style="color: #7f8c8d; font-size: 16px; margin-bottom: 20px;">
          No se encontró ningún contacto con la referencia: <strong><%= @reference %></strong>
        </p>
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin-top: 20px;">
          <strong>Consejos:</strong>
          <ul style="text-align: left; margin: 10px 0 0 0; padding-left: 20px;">
            <li>Verifica que el número de referencia esté correcto</li>
            <li>Las referencias tienen formato: WA240805001</li>
            <li>El sistema distingue entre mayúsculas y minúsculas</li>
          </ul>
        </div>
      </div>
    <% end %>
  <% end %>
</div>